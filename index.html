<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>zzy - 学号点名</title>
    <link rel="stylesheet" href="weui-master/dist/style/weui.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/display.css">
    
    <style>
        /* 轻量兜底，主样式在 assets/css/style.css */
        .hidden { display: none; }
    </style>
    <script defer src="assets/js/utils.js"></script>
    <script defer src="assets/js/roster.js"></script>
    <script defer src="assets/js/banner.js"></script>
    <script defer src="assets/js/whatsnew.js"></script>
    
    <script defer src="assets/js/confetti.js"></script>
    <script defer src="assets/js/app.js"></script>
    <script>
        // 简单防抖，避免 iOS PWA 双击放大
        document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
    </script>
    <meta name="theme-color" content="#12b76a" id="metaThemeColor">
</head>
<body data-weui-theme="light">
    <div id="appLoader" class="loader" aria-live="polite" aria-busy="true">
        <div class="loader__spinner" role="status" aria-label="正在加载"></div>
        <div class="loader__text"><span id="loaderStatus">正在加载，请稍候…</span></div>
        <div class="loader__progress">
            <div class="loader__bar"><div id="loaderBarInner" class="loader__bar-inner" style="width:0%"></div></div>
            <div class="loader__meta">
                <span id="loaderFile">-</span>
                <span id="loaderPct">0%</span>
            </div>
        </div>
        <button id="btnForceStart" class="weui-btn weui-btn_mini weui-btn_default" style="margin-top:8px;">强制进入</button>
    </div>
    <div class="app hidden-onload">
        <header class="app__header">
            <div class="app__brand">
                <span class="brand__logo">🎯</span>
                <h1 class="brand__title">学号随机点名</h1>
            </div>
            <button id="btnOpenSettings" class="weui-btn weui-btn_default app__settings-btn" aria-label="打开设置">设置</button>
        </header>

        <!-- 顶部横幅（可复用，默认隐藏） -->
        <div id="topBanner" class="banner hidden" role="status" aria-live="polite">
            <div class="banner__inner">
                <span id="topBannerText" class="banner__text">这是一个测试横幅</span>
                <button id="topBannerClose" class="banner__close" aria-label="关闭" title="关闭">×</button>
            </div>
        </div>

        <main class="app__main">
            <section class="card card--panel">
                <div id="rangeBar" class="range-cells">
                    <div class="weui-cells weui-cells_form">
                        <div class="weui-cell weui-cell_active">
                            <div class="weui-cell__hd"><label for="inputMin" class="weui-label">最小学号</label></div>
                            <div class="weui-cell__bd"><input id="inputMin" type="text" inputmode="text" class="weui-input" placeholder="最小学号阈值（如 1）"></div>
                        </div>
                    </div>
                    <div class="weui-cells weui-cells_form">
                        <div class="weui-cell weui-cell_active">
                            <div class="weui-cell__hd"><label for="inputMax" class="weui-label">最大学号</label></div>
                            <div class="weui-cell__bd"><input id="inputMax" type="text" inputmode="text" class="weui-input" placeholder="最大学号阈值（如 50）"></div>
                        </div>
                    </div>
                    <div class="weui-cells weui-cells_form">
                        <div class="weui-cell weui-cell_active">
                            <div class="weui-cell__hd"><label for="inputExclude" class="weui-label">排除学号</label></div>
                            <div class="weui-cell__bd"><input id="inputExclude" type="text" inputmode="text" class="weui-input" placeholder="学号中间用英文逗号隔开"></div>
                        </div>
                    </div>
                </div>

                

                <div class="display">
                    <div id="displayLabel" class="display__label">当前学号</div>
                    <div id="displayNumber" class="display__number is-placeholder">填写必要设置后开始！</div>
                    <div id="displayName" class="display__name hidden">—</div>
                    <div id="displayCountdown" class="display__countdown hidden">—</div>
                </div>

                <div class="controls controls--bottom">
                    <div class="controls__primary">
                        <button class="weui-btn weui-btn_primary btn-ripple js-ripple js-start">开始滚动</button>
                        <button class="weui-btn weui-btn_warn btn-ripple js-ripple js-stop hidden">停止并点名</button>
                    </div>
                    <button id="btnAuto5s" class="weui-btn weui-btn_default btn-ripple js-ripple">5秒随机抽人</button>
                </div>
            </section>

            
        </main>

        <div class="app__share-tip" style="text-align:center;color:var(--brand-ink);margin:8px 0 16px;">🎉好用的话可以推荐给其他老师！🎉</div>

        <footer class="app__footer">
            <div class="app__actions">
                <button id="btnToggleTheme" class="weui-btn weui-btn_default weui-btn_mini btn-ripple js-ripple">切换主题</button>
                <button id="btnWhatsNew" class="weui-btn weui-btn_default weui-btn_mini btn-ripple js-ripple">新功能</button>
                <div class="footer__profile">
                    <span class="profile__label">班级：</span>
                    <select id="profileSelect" class="weui-select footer-select"></select>
                </div>
            </div>
            <div class="app__meta">
                <span>此页面部分内容基于AI技术生成。</span>
                <span class="dot">·</span>
                <span>浏览器：<span id="browserInfo">-</span></span>
                <span class="dot">·</span>
                <span>版本：v3.1.1</span>
                <span class="dot">·</span>
                <span>台州王浩哥集团有限公司 © 2025</span>
                <span class="dot">·</span>
                <span>赠送:詹珍怡及其所有朋友(请认准:<a href="https://zhanzhenyi.cn" target="_blank" style="color: var(--brand);">zhanzhenyi.cn</a>)欢迎推荐此网站！</span>
            </div>
        </footer>
    </div>

    <!-- 设置弹窗 -->
    <div id="settingsSheet" class="weui-mask hidden" role="dialog" aria-modal="true">
        <div class="sheet">
            <div class="sheet__header">高级设置<button id="btnSettingsClose" class="sheet__close" aria-label="关闭" style="color: red;">×</button></div>
            <div class="sheet__content">
                <div class="weui-cells__title"><span class="title-with-icon"><img class="icon" src="assets/img/menu/Class.png" alt="" aria-hidden="true">班级配置</span></div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <select id="profileSelectSettings" class="weui-select"></select>
                    </div>
                    <div class="weui-cell__ft" style="white-space: nowrap;">
                        <button id="btnProfileNew" class="weui-btn weui-btn_mini weui-btn_default">新建</button>
                        <button id="btnProfileRename" class="weui-btn weui-btn_mini weui-btn_default" style="margin-left:8px;">重命名</button>
                        <button id="btnProfileDelete" class="weui-btn weui-btn_mini weui-btn_warn" style="margin-left:8px;">删除</button>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">导入/导出</div>
                    <div class="weui-cell__ft" style="white-space: nowrap;">
                        <button id="btnProfileExport" class="weui-btn weui-btn_mini weui-btn_default">导出当前班级</button>
                        <button id="btnProfileImport" class="weui-btn weui-btn_mini weui-btn_default" style="margin-left:8px;">导入班级</button>
                        <input id="inputImportProfile" type="file" accept="application/json" class="hidden">
                    </div>
                </div>
                <div class="weui-cells__title"><span class="title-with-icon"><img class="icon" src="assets/img/menu/Regular.png" alt="" aria-hidden="true">常规设置</span></div>
                <label class="weui-cell weui-cell_switch">
                    <div class="weui-cell__bd">不重复点到（抽过不再出现）</div>
                    <div class="weui-cell__ft">
                        <input id="switchNoRepeat" class="weui-switch" type="checkbox" checked>
                    </div>
                </label>
                <div class="weui-cell">
                    <div class="weui-cell__bd">已抽名单</div>
                    <div class="weui-cell__ft" style="white-space: nowrap;">
                        <button id="btnClearPicked" class="weui-btn weui-btn_mini weui-btn_warn">清空已抽</button>
                    </div>
                </div>
                <label class="weui-cell">
                    <div class="weui-cell__bd">何时清空不重复名单？</div>
                    <div class="weui-cell__ft">
                        <select id="selectNoRepeatExpire" class="weui-select">
                            <option value="session" selected>网页刷新后</option>
                            <option value="40m">40分钟后</option>
                            <option value="1d">一天后</option>
                        </select>
                    </div>
                </label>
                <label class="weui-cell weui-cell_switch">
                    <div class="weui-cell__bd">启用滚动动画（更有仪式感）</div>
                    <div class="weui-cell__ft">
                        <input id="switchAnimate" class="weui-switch" type="checkbox" checked>
                    </div>
                </label>

                <label class="weui-cell weui-cell_switch">
                    <div class="weui-cell__bd">显示顶部设置栏</div>
                    <div class="weui-cell__ft">
                        <input id="switchShowRangeBar" class="weui-switch" type="checkbox" checked>
                    </div>
                </label>

                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <label for="inputAutoSeconds" class="weui-label">自动抽人时长</label>
                        <input id="inputAutoSeconds" type="range" min="1" max="10" value="5" style="width:100%">
                        <div style="margin-top:6px;color:var(--muted);">当前：<span id="autoSecondsPreview">5</span> 秒</div>
                    </div>
                </div>

                <div class="weui-cells__title"><span class="title-with-icon"><img class="icon" src="assets/img/menu/List.png" alt="" aria-hidden="true">名单管理</span></div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">自定义名单</div>
                    <div class="weui-cell__ft">
                        <button id="btnOpenRoster" class="weui-btn weui-btn_mini weui-btn_default btn-icon" title="打开">
                            <img class="open-icon open-icon--light" src="assets/img/open/Open_Black.png" alt="" aria-hidden="true">
                            <img class="open-icon open-icon--dark" src="assets/img/open/Open_White.png" alt="" aria-hidden="true">
                            打开
                        </button>
                    </div>
                </div>

                <div class="weui-cells__title"><span class="title-with-icon"><img class="icon" src="assets/img/menu/Color.png" alt="" aria-hidden="true">主题色设置</span></div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">设置全局主题色</div>
                    <div class="weui-cell__ft">
                        <button id="btnOpenTheme" class="weui-btn weui-btn_mini weui-btn_default btn-icon" title="打开">
                            <img class="open-icon open-icon--light" src="assets/img/open/Open_Black.png" alt="" aria-hidden="true">
                            <img class="open-icon open-icon--dark" src="assets/img/open/Open_White.png" alt="" aria-hidden="true">
                            打开
                        </button>
                    </div>
                </div>

                <div class="weui-cells__title"><span class="title-with-icon"><img class="icon" src="assets/img/menu/Regular.png" alt="" aria-hidden="true">Core模式</span></div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">进入 Core 模式（UI界面用不了的情况下）</div>
                    <div class="weui-cell__ft">
                        <button id="btnOpenCore" class="weui-btn weui-btn_mini weui-btn_default btn-icon" title="打开">
                            <img class="open-icon open-icon--light" src="assets/img/open/Open_Black.png" alt="" aria-hidden="true">
                            <img class="open-icon open-icon--dark" src="assets/img/open/Open_White.png" alt="" aria-hidden="true">
                            打开
                        </button>
                    </div>
                </div>

                <div class="weui-cells__title"><span class="title-with-icon"><img class="icon" src="assets/img/menu/PlusSettings.png" alt="" aria-hidden="true">高级抽取策略</span></div>
                <label class="weui-cell weui-cell_switch">
                    <div class="weui-cell__bd">启用概率权重(可以设置每个学号抽中的概率)</div>
                    <div class="weui-cell__ft">
                        <input id="switchEnableWeights" class="weui-switch" type="checkbox">
                    </div>
                </label>
                <label class="weui-cell weui-cell_switch">
                    <div class="weui-cell__bd">掩盖概率设置（滚动时假装没设置概率？）</div>
                    <div class="weui-cell__ft">
                        <input id="switchWeightsMask" class="weui-switch" type="checkbox">
                    </div>
                </label>
                <div class="weui-cell">
                    <div class="weui-cell__bd">概率权重设置（按范围配置百分比）</div>
                    <div class="weui-cell__ft">
                        <button id="btnOpenWeights" class="weui-btn weui-btn_mini weui-btn_default btn-icon" title="打开">
                            <img class="open-icon open-icon--light" src="assets/img/open/Open_Black.png" alt="" aria-hidden="true">
                            <img class="open-icon open-icon--dark" src="assets/img/open/Open_White.png" alt="" aria-hidden="true">
                            打开
                        </button>
                    </div>
                </div>
            </div>
            <div class="sheet__footer">
                <button id="btnSettingsCancel" class="weui-btn weui-btn_default">取消</button>
                <button id="btnSettingsSave" class="weui-btn weui-btn_primary">保存</button>
            </div>
        </div>
    </div>

    <!-- 新功能弹窗 -->
    <div id="whatsNewSheet" class="weui-mask hidden" role="dialog" aria-modal="true" style="z-index: 999999999;">
        <div class="sheet">
            <div class="sheet__header">新功能<button id="btnWhatsNewClose" class="sheet__close" aria-label="关闭">×</button></div>
            <div class="sheet__content">
                <div class="weui-cells__title">当前版本：v3.1.1</div>
                <div class="weui-cells">
                    <div class="weui-cell">新增：主题色设置（调色盘、预设、自定义预设保存）</div>
                    <div class="weui-cell">新增：每个班级保存各自主题色，切换班级自动切换颜色</div>
                    <div class="weui-cell">优化：深色模式整体提亮，边框/阴影/输入跟随主题联动</div>
                    <div class="weui-cell">修复：若干小问题和视觉细节</div>
                    <div class="weui-cell">2025年9月18日  更新 感谢您的支持</div>
                </div>
            </div>
            <div class="sheet__footer">
                <button id="btnWhatsNewOk" class="weui-btn weui-btn_primary">知道了</button>
            </div>
        </div>
    </div>

    <!-- 概率权重设置弹窗 -->
    <div id="weightsSheet" class="weui-mask hidden" role="dialog" aria-modal="true">
        <div class="sheet">
            <div class="sheet__header">概率权重设置（按学号）<button id="btnWeightsClose" class="sheet__close" aria-label="关闭">×</button></div>
            <div class="sheet__content">
                <div class="weui-cells__title">为单个学号设置抽中百分比（未设置者平均分配剩余百分比）。</div>
                <div class="weui-cells__tips" style="margin:6px 0;color:var(--muted);">提示：当前范围与排除条件内的学号，已设置的百分比合计建议不超过 100%；超过时，将仅在已设置学号间按占比抽取。</div>

                <label class="weui-cell weui-cell_switch">
                    <div class="weui-cell__bd">设置了概率的学号排除“不重复点到”设置(可以再次抽到)</div>
                    <div class="weui-cell__ft">
                        <input id="switchWeightsIgnoreNoRepeat" class="weui-switch" type="checkbox">
                    </div>
                </label>

                <div class="weui-cells" id="weightsList"></div>

                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <button id="btnWeightsAddId" class="weui-btn weui-btn_default weui-btn_mini">添加学号</button>
                        <button id="btnWeightsAddGroup" class="weui-btn weui-btn_default weui-btn_mini" style="margin-left:8px;">添加学号组</button>
                        <button id="btnWeightsClear" class="weui-btn weui-btn_warn weui-btn_mini" style="margin-left:8px;">清空</button>
                    </div>
                    <div class="weui-cell__ft" style="white-space:nowrap;">当前范围内已分配：<span id="weightsTotal">0%</span></div>
                </div>
            </div>
            <div class="sheet__footer">
                <button id="btnWeightsCancel" class="weui-btn weui-btn_default">取消</button>
                <button id="btnWeightsSave" class="weui-btn weui-btn_primary">保存</button>
            </div>
        </div>
    </div>

    <!-- 自定义名单设置弹窗 -->
    <div id="rosterSheet" class="weui-mask hidden" role="dialog" aria-modal="true">
        <div class="sheet">
            <div class="sheet__header">自定义名单<button id="btnRosterClose" class="sheet__close" aria-label="关闭">×</button></div>
            <div class="sheet__content">
                <div class="weui-cells__title">格式：学号+空格+姓名，一行一个</div>
                <div class="weui-cells">
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <textarea id="textareaRoster" class="weui-textarea" placeholder="示例：每行=学号 空格 姓名&#10;1 张三&#10;2 李四&#10;3 王五" rows="10"></textarea>
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <div id="rosterStats" style="color:var(--muted);">共 0 行 · 合法 0 · 无效 0 · 重复 0</div>
                        </div>
                        <div class="weui-cell__ft" style="white-space: nowrap;">
                            <button id="btnRosterFormat" class="weui-btn weui-btn_mini weui-btn_default">格式化</button>
                            <button id="btnRosterSortId" class="weui-btn weui-btn_mini weui-btn_default" style="margin-left:8px;">按学号排序</button>
                            <button id="btnRosterSortName" class="weui-btn weui-btn_mini weui-btn_default" style="margin-left:8px;">按姓名排序</button>
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__bd">批量处理</div>
                        <div class="weui-cell__ft" style="white-space: nowrap;">
                            <button id="btnRosterDedup" class="weui-btn weui-btn_mini weui-btn_default">按学号去重</button>
                            <button id="btnRosterTrim" class="weui-btn weui-btn_mini weui-btn_default" style="margin-left:8px;">去空行</button>
                            <button id="btnRosterCopy" class="weui-btn weui-btn_mini weui-btn_default" style="margin-left:8px;">复制</button>
                            <button id="btnRosterPaste" class="weui-btn weui-btn_mini weui-btn_default" style="margin-left:8px;">粘贴</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sheet__footer">
                <button id="btnRosterCancel" class="weui-btn weui-btn_default">取消</button>
                <button id="btnRosterClear" class="weui-btn weui-btn_warn">清空</button>
                <button id="btnRosterSave" class="weui-btn weui-btn_primary">保存</button>
            </div>
        </div>
    </div>

    <!-- 主题色设置弹窗 -->
    <div id="themeSheet" class="weui-mask hidden" role="dialog" aria-modal="true">
        <div class="sheet">
            <div class="sheet__header">主题色设置<button id="btnThemeClose" class="sheet__close" aria-label="关闭">×</button></div>
            <div class="sheet__content">
                <div class="weui-cells__title">选择一个主题色，或使用调色盘自定义。</div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <input id="inputThemeColor" type="color" value="#12b76a" style="width:52px;height:32px;border:0;padding:0;background:transparent;">
                    </div>
                    <div class="weui-cell__ft" style="white-space:nowrap;">
                        <button id="btnThemeReset" class="weui-btn weui-btn_mini weui-btn_default">恢复默认</button>
                        <button id="btnThemeSaveCustom" class="weui-btn weui-btn_mini weui-btn_default" style="margin-left:8px;">保存到预设</button>
                    </div>
                </div>
                <div class="weui-cells__title">预设颜色</div>
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <div id="themeSwatches" class="swatches">
                            <button class="swatch" data-color="#12b76a" style="--c:#12b76a" title="#12b76a"></button>
                            <button class="swatch" data-color="#0ea5e9" style="--c:#0ea5e9" title="#0ea5e9"></button>
                            <button class="swatch" data-color="#6366f1" style="--c:#6366f1" title="#6366f1"></button>
                            <button class="swatch" data-color="#f59e0b" style="--c:#f59e0b" title="#f59e0b"></button>
                            <button class="swatch" data-color="#ef4444" style="--c:#ef4444" title="#ef4444"></button>
                            <button class="swatch" data-color="#06b6d4" style="--c:#06b6d4" title="#06b6d4"></button>
                            <button class="swatch" data-color="#22c55e" style="--c:#22c55e" title="#22c55e"></button>
                            <button class="swatch" data-color="#a855f7" style="--c:#a855f7" title="#a855f7"></button>
                            <span id="themeCustomColors" style="display:contents;"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sheet__footer">
                <button id="btnThemeCancel" class="weui-btn weui-btn_default">取消</button>
                <button id="btnThemeSave" class="weui-btn weui-btn_primary">保存</button>
            </div>
        </div>
    </div>
    <script>
        (function(){
            var loader = document.getElementById('appLoader');
            var statusEl = document.getElementById('loaderStatus');
            var fileEl = document.getElementById('loaderFile');
            var pctEl = document.getElementById('loaderPct');
            var barInner = document.getElementById('loaderBarInner');
            var btnForce = document.getElementById('btnForceStart');

            function showApp(){
                var app = document.querySelector('.app');
                if(app) app.classList.remove('hidden-onload');
                if(loader && loader.parentNode) loader.parentNode.removeChild(loader);
            }

            function fontsReady(){
                var fonts = document.fonts;
                if(fonts && fonts.ready){ return fonts.ready.catch(function(){}); }
                return Promise.resolve();
            }

            function setProgress(name, loaded, total){
                var pct = total > 0 ? Math.round(loaded / total * 100) : (document.readyState === 'complete' ? 100 : 0);
                if (fileEl) fileEl.textContent = name || '-';
                if (pctEl) pctEl.textContent = pct + '%';
                if (barInner) barInner.style.width = pct + '%';
            }

            btnForce && btnForce.addEventListener('click', function(){ showApp(); });

            // Track external CSS/JS resources
            var res = [];
            try {
                var links = Array.prototype.slice.call(document.querySelectorAll('link[rel="stylesheet"][href]'));
                var scripts = Array.prototype.slice.call(document.querySelectorAll('script[defer][src]'));
                links.forEach(function(el){ res.push({ el: el, url: el.getAttribute('href') }); });
                scripts.forEach(function(el){ res.push({ el: el, url: el.getAttribute('src') }); });
            } catch (e) {}

            var total = res.length;
            var loaded = 0;
            if (total === 0) setProgress('-', 1, 1);

            res.forEach(function(item){
                var done = false;
                function mark(){ if (done) return; done = true; loaded++; setProgress(item.url, loaded, total); if (loaded >= total) onAllLoaded(); }
                item.el.addEventListener('load', mark);
                item.el.addEventListener('error', mark);
                // If already complete (some browsers), mark in next tick
                setTimeout(function(){
                    // Heuristic: CSS with sheet present, or script with readyState === 'complete'
                    try {
                        if ((item.el.tagName === 'LINK' && item.el.sheet) || (item.el.tagName === 'SCRIPT' && (item.el.readyState === 'complete'))){ mark(); }
                    } catch (_) {}
                }, 0);
            });

            function onAllLoaded(){
                statusEl && (statusEl.textContent = '初始化字体…');
                fontsReady().then(function(){ statusEl && (statusEl.textContent = '就绪'); setProgress('完成', 1, 1); }).then(function(){
                    // 若页面已完全加载或用户强制，则展示
                    if (document.readyState === 'complete') showApp();
                    else window.addEventListener('load', function(){ showApp(); }, { once: true });
                });
            }

            if (document.readyState === 'complete') { setProgress('完成', 1, 1); showApp(); return; }

            // 兜底：即便资源事件缺失，onload 时也会显示
            window.addEventListener('load', function(){ setProgress('完成', total, total); onAllLoaded(); }, { once: true });
        })();
    </script>

</body>
</html>

